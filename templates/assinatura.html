<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assinatura de Documento - Ironberg</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        h1, h3 { text-align: center; }
        .documento { background-color: #f9f9f9; padding: 20px; border: 1px solid #eee; margin-bottom: 20px; }
        .assinatura-box { border: 2px dashed #ccc; background-color: #f0f0f0; margin-bottom: 20px; touch-action: none; }
        .motivos { margin: 20px 0; }
        #texto_outros { display: none; width: 98%; margin-top: 10px; padding: 5px; }
        button { width: 100%; padding: 15px; font-size: 18px; color: white; background-color: #28a745; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #218838; }
        button:disabled { background-color: #aaa; cursor: not-allowed;}
        .mensagem-sucesso { text-align: center; padding: 20px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724; }
    </style>
</head>
<body>

    <div id="conteudo-principal">
        <h1>SOLICITAÇÃO DE NÃO RENOVAÇÃO DE CONTRATO</h1>
        <h3>IRONBERG</h3>
        <div class="documento">
            <p>EU, <strong>{{ nome }}</strong>, CPF: <strong>{{ cpf }}</strong>, MATRÍCULA: <strong>{{ matricula }}</strong> ... </p>
            <p>Estou ciente de que ...</p>
            <p>DATA: <strong>{{ data_solicitacao }}</strong></p>
            <p>CONSULTOR(A) RESPONSÁVEL: <strong>{{ consultor }}</strong></p>
        </div>
        <div class="motivos">
            <h4>MOTIVO DO CANCELAMENTO:</h4>
            <input type="radio" id="motivo1" name="motivo" value="atendimento_professores"><label for="motivo1">NÃO GOSTEI DO ATENDIMENTO DOS PROFESSORES</label><br>
            <input type="radio" id="motivo2" name="motivo" value="atendimento_recepcao"><label for="motivo2">NÃO GOSTEI DO ATENDIMENTO DA RECEPÇÃO</label><br>
            <input type="radio" id="motivo3" name="motivo" value="problemas_saude"><label for="motivo3">ESTOU COM PROBLEMAS DE SAÚDE</label><br>
            <input type="radio" id="motivo4" name="motivo" value="dificuldade_financeira"><label for="motivo4">ESTOU COM DIFICULDADE FINANCEIRA</label><br>
            <input type="radio" id="motivo5" name="motivo" value="mudei_endereco"><label for="motivo5">MUDEI DE ENDEREÇO</label><br>
            <input type="radio" id="motivo_outros" name="motivo" value="outros"><label for="motivo_outros">OUTROS, DESCREVA:</label><br>
            <textarea id="texto_outros" name="texto_outros" rows="3"></textarea>
        </div>
        <h4>ASSINATURA:</h4>
        <div class="assinatura-box">
            <canvas id="signature-pad" width="760" height="200"></canvas>
        </div>
        <button id="btn-finalizar">ASSINAR E FINALIZAR</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
        // --- LÓGICA PARA O FORMULÁRIO DE MOTIVOS ---
        const radios = document.querySelectorAll('input[name="motivo"]');
        const textAreaOutros = document.getElementById('texto_outros');
        radios.forEach(radio => {
            radio.addEventListener('change', () => {
                textAreaOutros.style.display = radio.value === 'outros' ? 'block' : 'none';
            });
        });

        // --- LÓGICA PARA A CAIXA DE ASSINATURA ---
        const canvas = document.querySelector("#signature-pad");
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(240, 240, 240)' });
        function resizeCanvas() {
            const ratio =  Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        // --- NOVA LÓGICA PARA O BOTÃO FINALIZAR ---
        const botaoFinalizar = document.getElementById('btn-finalizar');
        const conteudoPrincipal = document.getElementById('conteudo-principal');

        botaoFinalizar.addEventListener('click', () => {
            // 1. Validar se algo foi assinado e um motivo foi selecionado
            if (signaturePad.isEmpty()) {
                return alert("Por favor, forneça sua assinatura.");
            }
            const motivoSelecionado = document.querySelector('input[name="motivo"]:checked');
            if (!motivoSelecionado) {
                return alert("Por favor, selecione o motivo do cancelamento.");
            }

            // Desabilita o botão para evitar cliques duplos
            botaoFinalizar.disabled = true;
            botaoFinalizar.textContent = 'Processando...';

            // 2. Coletar os dados
            const dadosParaEnviar = {
                motivo: motivoSelecionado.value,
                texto_outros: textAreaOutros.value,
                assinatura: signaturePad.toDataURL('image/png') // Converte o desenho para texto Base64
            };

            // 3. Enviar para o servidor
            const token = "{{ token }}"; // Pega o token que o Flask enviou para a página
            fetch(`/assinar/${token}/finalizar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dadosParaEnviar),
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    // 4. Mostrar mensagem de sucesso e link para o PDF
                    conteudoPrincipal.innerHTML = `
                        <div class="mensagem-sucesso">
                            <h2>${data.mensagem}</h2>
                            <p>O documento foi finalizado e salvo.</p>
                            <a href="${data.url_pdf}" target="_blank" download>
                                <button>Baixar PDF Assinado</button>
                            </a>
                        </div>
                    `;
                } else {
                    alert('Erro: ' + data.mensagem);
                    botaoFinalizar.disabled = false;
                    botaoFinalizar.textContent = 'ASSINAR E FINALIZAR';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Ocorreu um erro de comunicação com o servidor.');
                botaoFinalizar.disabled = false;
                botaoFinalizar.textContent = 'ASSINAR E FINALIZAR';
            });
        });
    </script>
</body>
</html>