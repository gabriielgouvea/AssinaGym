<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assinatura de Documento - Ironberg</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        h1, h3 { text-align: center; }
        .documento { background-color: #f9f9f9; padding: 20px; border: 1px solid #eee; margin-bottom: 20px; }
        
        .assinatura-container { position: relative; }
        .assinatura-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ccc;
            font-size: 2.5em;
            font-weight: bold;
            pointer-events: none;
        }

        .assinatura-box { border: 2px dashed #ccc; background-color: #f0f0f0; margin-bottom: 10px; touch-action: none; }
        #signature-pad { width: 100%; height: 200px; background-color: #f0f0f0; }
        
        .motivos, .concordancia { margin: 20px 0; }
        .concordancia { border: 1px solid #ffc107; background-color: #fff3cd; padding: 15px; border-radius: 5px; }
        #texto_outros { display: none; width: 98%; margin-top: 10px; padding: 5px; }
        .botoes-container { display: flex; gap: 10px; }
        button { width: 100%; padding: 15px; font-size: 18px; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #btn-finalizar { background-color: #28a745; }
        #btn-finalizar:hover { background-color: #218838; }
        #btn-limpar { background-color: #6c757d; }
        #btn-limpar:hover { background-color: #5a6268; }
        button:disabled { background-color: #aaa; cursor: not-allowed;}
        .mensagem-sucesso { text-align: center; padding: 20px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724; }
        .mensagem-sucesso button { background-color: #28a745; }
        .mensagem-sucesso button:hover { background-color: #218838; }
    </style>
</head>
<body>
    <div id="conteudo-principal">
        <h1>SOLICITAÇÃO DE NÃO RENOVAÇÃO DE CONTRATO</h1>
        <h3>IRONBERG</h3>
        <div class="documento">
            <p>
                EU, <strong>{{ nome }}</strong>, CPF: <strong>{{ cpf }}</strong>, MATRÍCULA: <strong>{{ matricula }}</strong>
                SOLICITO A FINALIZAÇÃO DO MEU CONTRATO FIRMADO COM A EMPRESA IRONBERG
                ALPHAVILLE CNPJ 55.157.797.0001/06, NO DIA {{ data_inicio_contrato }}, EFETUEI O PAGAMENTO
                NO VALOR DE R$ {{ valor_multa }} REFERENTE A RESCISÃO ANTECIPADA DO MEU
                CONTRATO.
            </p>
            <p>DATA: <strong>{{ data_solicitacao }}</strong></p>
            <p>CONSULTOR(A) RESPONSÁVEL: <strong>{{ consultor }}</strong></p>
        </div>
        <div class="motivos">
            <h4>1. MOTIVO DO CANCELAMENTO (Obrigatório):</h4>
            <input type="radio" id="motivo1" name="motivo" value="atendimento_professores"><label for="motivo1">NÃO GOSTEI DO ATENDIMENTO DOS PROFESSORES</label><br>
            <input type="radio" id="motivo2" name="motivo" value="atendimento_recepcao"><label for="motivo2">NÃO GOSTEI DO ATENDIMENTO DA RECEPÇÃO</label><br>
            <input type="radio" id="motivo3" name="motivo" value="problemas_saude"><label for="motivo3">ESTOU COM PROBLEMAS DE SAÚDE</label><br>
            <input type="radio" id="motivo4" name="motivo" value="dificuldade_financeira"><label for="motivo4">ESTOU COM DIFICULDADE FINANCEIRA</label><br>
            <input type="radio" id="motivo5" name="motivo" value="mudei_endereco"><label for="motivo5">MUDEI DE ENDEREÇO</label><br>
            <input type="radio" id="motivo_outros" name="motivo" value="outros"><label for="motivo_outros">OUTROS, DESCREVA:</label><br>
            <textarea id="texto_outros" name="texto_outros" rows="3"></textarea>
        </div>
        <div class="concordancia">
            <h4>2. TERMO DE CIÊNCIA (Obrigatório):</h4>
            <input type="checkbox" id="check_ciencia" name="check_ciencia">
            <label for="check_ciencia">
                Estou ciente de que, caso exista alguma mensalidade com vencimento nos próximos 30 dias,
                a cobrança será realizada (seja por débito automático no cartão de crédito ou por pagamento antecipado no ato do cancelamento),
                e o cancelamento do plano só será efetivado após a quitação deste valor.
            </label>
        </div>
        <h4>3. ASSINATURA (Obrigatório):</h4>
        <div class="assinatura-container">
            <div class="assinatura-placeholder">Assine aqui</div>
            <div class="assinatura-box">
                <canvas id="signature-pad"></canvas>
            </div>
        </div>
        <div class="botoes-container">
            <button id="btn-limpar">LIMPAR ASSINATURA</button>
            <button id="btn-finalizar">ASSINAR E FINALIZAR</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
        const radios = document.querySelectorAll('input[name="motivo"]');
        const textAreaOutros = document.getElementById('texto_outros');
        radios.forEach(radio => {
            radio.addEventListener('change', () => {
                textAreaOutros.style.display = radio.value === 'outros' ? 'block' : 'none';
            });
        });

        const canvas = document.querySelector("#signature-pad");
        const placeholder = document.querySelector(".assinatura-placeholder");
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(240, 240, 240)' });

        signaturePad.addEventListener("beginStroke", () => {
            placeholder.style.display = "none";
        });

        function resizeCanvas() {
            const ratio =  Math.max(window.devicePixelRatio || 1, 1);
            const BoundingBox = canvas.getBoundingClientRect();
            canvas.width = BoundingBox.width * ratio;
            canvas.height = BoundingBox.height * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
            placeholder.style.display = "block";
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        const botaoFinalizar = document.getElementById('btn-finalizar');
        const botaoLimpar = document.getElementById('btn-limpar');
        const conteudoPrincipal = document.getElementById('conteudo-principal');

        botaoLimpar.addEventListener('click', () => {
            signaturePad.clear();
            placeholder.style.display = "block";
        });

        botaoFinalizar.addEventListener('click', () => {
            const motivoSelecionado = document.querySelector('input[name="motivo"]:checked');
            const cienciaCheckbox = document.getElementById('check_ciencia');

            if (!motivoSelecionado) { return alert("Por favor, selecione o motivo do cancelamento."); }
            if (!cienciaCheckbox.checked) { return alert("Por favor, marque a caixa de 'Termo de Ciência' para continuar."); }
            if (signaturePad.isEmpty()) { return alert("Por favor, forneça sua assinatura no campo indicado."); }

            botaoFinalizar.disabled = true;
            botaoFinalizar.textContent = 'Processando...';

            const dadosParaEnviar = {
                motivo: motivoSelecionado.value,
                texto_outros: textAreaOutros.value,
                assinatura: signaturePad.toDataURL('image/png'),
                ciencia_concordancia: cienciaCheckbox.checked
            };

            const token = "{{ token }}";
            fetch(`/assinar/${token}/finalizar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosParaEnviar),
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    const fullPdfUrl = window.location.origin + data.url_pdf;
                    const numeroWhatsApp = "5511955580797";
                    const mensagemWhatsApp = `Olá! Meu documento de cancelamento foi assinado e está disponível no link: ${fullPdfUrl}`;
                    const linkWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensagemWhatsApp)}`;
                    conteudoPrincipal.innerHTML = `
                        <div class="mensagem-sucesso">
                            <h2>${data.mensagem}</h2>
                            <p>O que você deseja fazer agora?</p>
                            <a href="${fullPdfUrl}" target="_blank" download style="text-decoration: none;">
                                <button>1. Baixar PDF Assinado</button>
                            </a>
                            <br><br>
                            <a href="${linkWhatsApp}" target="_blank" style="text-decoration: none;">
                                <button>2. Enviar para a Academia via WhatsApp</button>
                            </a>
                        </div>`;
                } else {
                    alert('Erro: ' + data.mensagem);
                    botaoFinalizar.disabled = false;
                    botaoFinalizar.textContent = 'ASSINAR E FINALIZAR';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Ocorreu um erro de comunicação com o servidor.');
                botaoFinalizar.disabled = false;
                botaoFinalizar.textContent = 'ASSINAR E FINALIZAR';
            });
        });
    </script>
</body>
</html>